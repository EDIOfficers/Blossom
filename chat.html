<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot - Blossom</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Lato:wght@300;400;700&display=swap">
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Chat interface specific styles */
    body {
      background-color: var(--primary-light);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .chat-header {
      background-color: var(--white);
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--primary-dark);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .back-button {
      display: flex;
      align-items: center;
      color: var(--text-medium);
      text-decoration: none;
      font-weight: 500;
    }
    
    .chat-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
      color: var(--text-dark);
    }
    
    .options-button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: var(--font-size-lg);
      color: var(--text-medium);
    }
    
    .chat-window {
      flex: 1;
      padding: var(--space-lg);
      overflow-y: auto;
      background-color: var(--primary-light);
      display: flex;
      flex-direction: column;
    }
    
    .date-separator {
      text-align: center;
      margin: var(--space-md) 0;
      font-size: var(--font-size-sm);
      color: var(--text-medium);
      position: relative;
    }
    
    .date-separator::before,
    .date-separator::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 30%;
      height: 1px;
      background-color: var(--primary-dark);
    }
    
    .date-separator::before {
      left: 0;
    }
    
    .date-separator::after {
      right: 0;
    }
    
    .message {
      max-width: 80%;
      margin-bottom: var(--space-md);
      animation: fadeIn 0.3s ease-out;
    }
    
    .message-user {
      align-self: flex-end;
      background-color: var(--accent);
      color: var(--white);
      border-radius: var(--border-radius-md) var(--border-radius-md) 0 var(--border-radius-md);
      padding: var(--space-md);
    }
    
    .message-bot {
      align-self: flex-start;
      background-color: var(--white);
      color: var(--text-dark);
      border-radius: 0 var(--border-radius-md) var(--border-radius-md) var(--border-radius-md);
      padding: var(--space-md);
      box-shadow: var(--shadow-sm);
    }
    
    .message-timestamp {
      font-size: var(--font-size-xs);
      color: var(--text-light);
      margin-top: var(--space-xs);
      text-align: right;
    }
    
    .typing-indicator {
      display: flex;
      align-items: center;
      margin-bottom: var(--space-md);
      align-self: flex-start;
    }
    
    .typing-bubble {
      width: 8px;
      height: 8px;
      margin: 0 2px;
      background-color: var(--accent);
      border-radius: 50%;
      opacity: 0.6;
    }
    
    .typing-bubble:nth-child(1) {
      animation: blink 1s infinite 0.2s;
    }
    
    .typing-bubble:nth-child(2) {
      animation: blink 1s infinite 0.4s;
    }
    
    .typing-bubble:nth-child(3) {
      animation: blink 1s infinite 0.6s;
    }
    
    @keyframes blink {
      0%, 100% {
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
    }
    
    .action-buttons {
      display: flex;
      gap: var(--space-sm);
      margin-top: var(--space-sm);
    }
    
    .action-button {
      font-size: var(--font-size-sm);
      padding: var(--space-xs) var(--space-sm);
      background-color: var(--primary-medium);
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .action-button:hover {
      background-color: var(--accent);
      color: var(--white);
    }
    
    .chat-input-container {
      padding: var(--space-md);
      background-color: var(--white);
      border-top: 1px solid var(--primary-dark);
      display: flex;
      align-items: center;
    }
    
    .chat-input {
      flex: 1;
      padding: var(--space-md);
      border: 1px solid var(--primary-dark);
      border-radius: var(--border-radius-md);
      font-family: var(--font-primary);
      font-size: var(--font-size-md);
      resize: none;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .send-button {
      margin-left: var(--space-md);
      background-color: var(--accent);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .send-button:hover {
      background-color: #b8869c;
    }
    
    .emoji-buttons {
      display: flex;
      gap: var(--space-xs);
      margin-right: var(--space-md);
    }
    
    .emoji-button {
      font-size: var(--font-size-lg);
      background: none;
      border: none;
      cursor: pointer;
      transition: transform var(--transition-fast);
    }
    
    .emoji-button:hover {
      transform: scale(1.2);
    }
  </style>
</head>
<body>
  <!-- Chat Container -->
  <div class="chat-container">
    <!-- Chat Header -->
    <div class="chat-header">
      <a href="home.html" class="back-button">
        <span>&larr;</span>&nbsp;Back
      </a>
      <div class="chat-title">Blossom Support</div>
      <button class="options-button">‚ãÆ</button>
    </div>
    
    <!-- Chat Window -->
    <div class="chat-window" id="chat-window">
      <div class="date-separator">Today</div>
      
      <!-- Welcome message from bot -->
      <div class="message message-bot">
        <div class="message-content">
          Hello there! I'm your Blossom companion. I'm here to listen and support you through your healing journey. How are you feeling today?
        </div>
        <div class="message-timestamp">10:00 AM</div>
        <div class="action-buttons">
          <button class="action-button">I'm feeling okay</button>
          <button class="action-button">I'm struggling today</button>
          <button class="action-button">I just want to talk</button>
        </div>
      </div>
      
      <!-- Typing indicator (initially hidden) -->
      <div class="typing-indicator" id="typing-indicator" style="display: none;">
        <div class="typing-bubble"></div>
        <div class="typing-bubble"></div>
        <div class="typing-bubble"></div>
      </div>
    </div>
    
    <!-- Chat Input -->
    <div class="chat-input-container">
      <div class="emoji-buttons">
        <button class="emoji-button">‚ù§Ô∏è</button>
        <button class="emoji-button">üòî</button>
        <button class="emoji-button">üòä</button>
      </div>
      <textarea class="chat-input" id="chat-input" placeholder="Type your message here..." rows="1"></textarea>
      <button class="send-button" id="send-button">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22 2L11 13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>

  <script src="js/storage.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Authentication check
      if (!Storage.isAuthenticated()) {
        window.location.href = 'auth.html';
        return;
      }
      
      // Get current user
      const currentUser = Storage.getCurrentUser();
      const username = currentUser.username;
      
      // Elements
      const chatWindow = document.getElementById('chat-window');
      const chatInput = document.getElementById('chat-input');
      const sendButton = document.getElementById('send-button');
      const typingIndicator = document.getElementById('typing-indicator');
      
      // Auto resize textarea
      chatInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
      
      // Create or get conversation
      let currentConversationId;
      
      function initializeChat() {
        // Create a new conversation if one doesn't exist
        currentConversationId = Storage.createNewConversation(username);
        
        // Add welcome message to storage
        const welcomeMessage = {
          sender: 'bot',
          content: "Hello there! I'm your Blossom companion. I'm here to listen and support you through your healing journey. How are you feeling today?",
          timestamp: new Date().toISOString()
        };
        
        Storage.saveChatMessage(username, currentConversationId, welcomeMessage);
      }
      
      // Add a message to the chat window
      function addMessageToChat(sender, content, timestamp) {
        const messageElement = document.createElement('div');
        messageElement.className = `message message-${sender}`;
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.textContent = content;
        messageElement.appendChild(messageContent);
        
        // Format timestamp
        const messageTime = new Date(timestamp);
        const formattedTime = messageTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        const timestampElement = document.createElement('div');
        timestampElement.className = 'message-timestamp';
        timestampElement.textContent = formattedTime;
        messageElement.appendChild(timestampElement);
        
        // Add action buttons if it's a bot message
        if (sender === 'bot') {
          // Simple response suggestions based on message content
          let suggestions = [];
          
          if (content.includes('feeling')) {
            suggestions = ["I'm feeling okay", "I'm struggling today", "I just want to talk"];
          } else if (content.includes('support')) {
            suggestions = ["Tell me more", "What resources are available?", "I need professional help"];
          } else {
            suggestions = ["Yes", "No", "Tell me more"];
          }
          
          if (suggestions.length > 0) {
            const actionButtons = document.createElement('div');
            actionButtons.className = 'action-buttons';
            
            suggestions.forEach(suggestion => {
              const button = document.createElement('button');
              button.className = 'action-button';
              button.textContent = suggestion;
              button.addEventListener('click', () => {
                sendMessage(suggestion);
              });
              actionButtons.appendChild(button);
            });
            
            messageElement.appendChild(actionButtons);
          }
        }
        
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }
      
      // Show typing indicator
      function showTypingIndicator() {
        typingIndicator.style.display = 'flex';
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }
      
      // Hide typing indicator
      function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
      }
      
      // Bot responses
      const botResponses = [
        {
          triggers: ['hello', 'hi', 'hey'],
          responses: [
            "Hi there. How are you feeling today?",
            "Hello. I'm here to listen. How are you doing?"
          ]
        },
        {
          triggers: ['sad', 'upset', 'unhappy', 'down', 'depressed', 'low'],
          responses: [
            "I'm sorry to hear you're feeling this way. It's completely understandable to feel sad after what you've been through.",
            "It's okay to feel sad. Your feelings are valid and important. Would you like to talk more about what's making you feel this way?",
            "Grief and sadness can come in waves. I'm here to listen whenever you need someone."
          ]
        },
        {
          triggers: ['angry', 'mad', 'frustrated', 'unfair'],
          responses: [
            "It's normal to feel angry or frustrated. These are natural responses to loss and you shouldn't feel guilty about them.",
            "Anger is a valid emotion in your healing journey. Would you like to explore ways to express this anger in healthy ways?",
            "I understand you're feeling frustrated. It's unfair what you've experienced, and it's okay to acknowledge that."
          ]
        },
        {
          triggers: ['scared', 'afraid', 'anxious', 'worried', 'fear'],
          responses: [
            "It's understandable to feel anxious or worried. Would it help to talk about your specific concerns?",
            "Fear is a common response after a miscarriage. Many people worry about the future. Is there something specific you're concerned about?",
            "Anxiety can be overwhelming. Remember to take things one day at a time. Would you like to try a simple breathing exercise together?"
          ]
        },
        {
          triggers: ['lonely', 'alone', 'isolated', 'no one understands'],
          responses: [
            "It can feel very isolating, but you're not alone in this experience. Many people feel the same way you do.",
            "I'm sorry you're feeling lonely. Would it help to connect with others who have had similar experiences?",
            "It's difficult when you feel like no one understands. I'm here to listen without judgment."
          ]
        },
        {
          triggers: ['hopeful', 'better', 'improving', 'positive'],
          responses: [
            "I'm glad you're feeling more hopeful. Small steps forward are worth celebrating.",
            "That's wonderful to hear. Healing isn't always linear, but these moments of positivity are important.",
            "I'm happy you're feeling better today. What has been helping you feel this way?"
          ]
        },
        {
          triggers: ['tired', 'exhausted', 'fatigued', 'sleep'],
          responses: [
            "Physical and emotional exhaustion are common during this time. Are you able to get enough rest?",
            "It can be difficult to sleep when you're processing grief. Would you like some gentle suggestions that might help?",
            "Feeling tired is natural as your body and mind are working hard to heal. Be gentle with yourself."
          ]
        },
        {
          triggers: ['guilty', 'blame', 'my fault', 'did something wrong'],
          responses: [
            "Please know that miscarriage is almost never caused by anything the mother did or didn't do. This was not your fault.",
            "Many people experience feelings of guilt after miscarriage, but it's important to know that you did nothing wrong.",
            "Self-blame is common, but miscarriage is almost always due to factors completely beyond your control."
          ]
        },
        {
          triggers: ['future', 'try again', 'pregnancy', 'baby'],
          responses: [
            "Thinking about the future can bring up many emotions. It's okay to take time before making any decisions.",
            "It's normal to have questions and concerns about future pregnancies. Have you spoken with your healthcare provider about this?",
            "Everyone's timeline for healing and moving forward is different. There's no rush to make any decisions right now."
          ]
        },
        {
          triggers: ['help', 'resource', 'support', 'therapy', 'counseling'],
          responses: [
            "There are many resources available to support you. Would you like to know about some support groups or counseling options?",
            "Professional support can be very helpful. Would you like me to suggest some resources?",
            "Talking with a counselor who specializes in pregnancy loss can be beneficial. Would you like information about finding one?"
          ]
        },
        {
          triggers: ['partner', 'husband', 'wife', 'spouse', 'relationship'],
          responses: [
            "Partners often grieve differently, which can sometimes create distance. Have you been able to talk with each other about how you're both feeling?",
            "It can be challenging when you and your partner process grief in different ways. Would it help to discuss some communication strategies?",
            "Your partner may also be grieving, though perhaps in a different way. Sometimes couples counseling can help navigate this together."
          ]
        },
        {
          triggers: ['physical', 'pain', 'bleeding', 'cramps', 'symptoms'],
          responses: [
            "If you're experiencing concerning physical symptoms, it's important to contact your healthcare provider right away.",
            "Physical recovery is an important part of healing. Have you been able to follow up with your doctor?",
            "Physical discomfort can add to the emotional difficulty. Are you managing okay with pain relief methods suggested by your doctor?"
          ]
        }
      ];
      
      // Default responses when no keyword match is found
      const defaultResponses = [
        "I'm here to listen. Can you tell me more about how you're feeling?",
        "Thank you for sharing that with me. Would you like to talk more about it?",
        "I understand this is a difficult time. What would be most helpful for you right now?",
        "I'm here to support you through this journey. Is there something specific you'd like to discuss?",
        "Your feelings are valid and important. Would you like to explore this further?"
      ];
      
      // Get bot response based on user message
      function getBotResponse(userMessage) {
        const lowercaseMessage = userMessage.toLowerCase();
        
        // Check for keyword matches
        for (const responseSet of botResponses) {
          for (const trigger of responseSet.triggers) {
            if (lowercaseMessage.includes(trigger)) {
              // Return random response from matched category
              const randomIndex = Math.floor(Math.random() * responseSet.responses.length);
              return responseSet.responses[randomIndex];
            }
          }
        }
        
        // No keyword match, return default response
        const randomIndex = Math.floor(Math.random() * defaultResponses.length);
        return defaultResponses[randomIndex];
      }
      
      // Send message function
      function sendMessage(message) {
        if (!message.trim()) return;
        
        const timestamp = new Date().toISOString();
        
        // Add user message to UI and storage
        addMessageToChat('user', message, timestamp);
        Storage.saveChatMessage(username, currentConversationId, {
          sender: 'user',
          content: message,
          timestamp
        });
        
        // Clear input
        chatInput.value = '';
        chatInput.style.height = 'auto';
        
        // Show typing indicator
        showTypingIndicator();
        
        // Simulate bot thinking and typing
        setTimeout(() => {
          hideTypingIndicator();
          
          // Generate and add bot response
          const botResponse = getBotResponse(message);
          const botTimestamp = new Date().toISOString();
          
          addMessageToChat('bot', botResponse, botTimestamp);
          Storage.saveChatMessage(username, currentConversationId, {
            sender: 'bot',
            content: botResponse,
            timestamp: botTimestamp
          });
        }, 1000 + Math.random() * 1000); // Random delay between 1-2 seconds
      }
      
      // Handle send button click
      sendButton.addEventListener('click', () => {
        sendMessage(chatInput.value);
      });
      
      // Handle enter key press
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage(chatInput.value);
        }
      });
      
      // Handle emoji button clicks
      document.querySelectorAll('.emoji-button').forEach(button => {
        button.addEventListener('click', () => {
          chatInput.value += button.textContent;
          chatInput.focus();
        });
      });
      
      // Initialize the chat
      initializeChat();
      
      // Load existing conversation or create a new one
      const chatHistory = Storage.getChatHistory(username);
      
      if (chatHistory && chatHistory.conversations.length > 0) {
        // Get the most recent conversation
        const latestConversation = chatHistory.conversations.sort((a, b) => 
          new Date(b.timestamp) - new Date(a.timestamp)
        )[0];
        
        currentConversationId = latestConversation.id;
        
        // Clear default welcome message
        chatWindow.innerHTML = '';
        
        // Add date separator
        const dateSeparator = document.createElement('div');
        dateSeparator.className = 'date-separator';
        dateSeparator.textContent = 'Today';
        chatWindow.appendChild(dateSeparator);
        
        // Load messages
        latestConversation.messages.forEach(message => {
          addMessageToChat(message.sender, message.content, message.timestamp);
        });
      }
    });
  </script>
</body>
</html>
